# CI ì „ìš© íŒŒì´í”„ë¼ì¸
# Pull Request ë° ê°œë°œ ë¸Œëœì¹˜ìš© - ë°°í¬ ì—†ëŠ” ê²€ì¦ë§Œ
# ë¹ ë¥¸ í”¼ë“œë°±ì„ ìœ„í•œ ìµœì í™”

steps:
  # =================================
  # Phase 1: í™˜ê²½ ì„¤ì •
  # =================================
  - name: 'node:18-slim'
    id: 'setup-environment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”§ CI í™˜ê²½ ì„¤ì • ì‹œì‘..."
        echo "Node.js ë²„ì „: $(node --version)"
        echo "npm ë²„ì „: $(npm --version)"
        echo "ë¹Œë“œ ID: $BUILD_ID"
        echo "ë¸Œëœì¹˜: $BRANCH_NAME"
        echo "ì»¤ë°‹: $SHORT_SHA"

  # =================================
  # Phase 2: ì˜ì¡´ì„± ì„¤ì¹˜
  # =================================
  - name: 'node:18-slim'
    id: 'install-dependencies'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘..."
        
        # ìºì‹œ ìµœì í™”ë¥¼ ìœ„í•œ npm ci ì‚¬ìš©
        npm ci
        
        echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
    waitFor: ['setup-environment']

  # =================================
  # Phase 3: ë³´ì•ˆ ìŠ¤ìº” - ì˜ì¡´ì„± ì·¨ì•½ì 
  # =================================
  - name: 'node:18-slim'
    id: 'security-audit'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”’ ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬ ì‹œì‘..."
        
        # npm audit ì‹¤í–‰ (moderate ì´ìƒ ì·¨ì•½ì  í™•ì¸)
        audit_result=$(npm audit --audit-level=moderate --json) || audit_exit_code=$?
        
        if [[ ${audit_exit_code:-0} -ne 0 ]]; then
          echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬!"
          
          # ì·¨ì•½ì  ìƒì„¸ ì •ë³´ ì¶œë ¥
          echo "$audit_result" | jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical") | "\(.key): \(.value.severity) - \(.value.title)"'
          
          # ìë™ ìˆ˜ì • ì‹œë„
          echo "ğŸ”§ ìë™ ìˆ˜ì • ì‹œë„..."
          npm audit fix --force || true
          
          # ì¬ê²€ì‚¬
          npm audit --audit-level=moderate || {
            echo "âŒ ìˆ˜ì • í›„ì—ë„ ì·¨ì•½ì  ì¡´ì¬. ìˆ˜ë™ ê²€í†  í•„ìš”"
            exit 1
          }
        fi
        
        echo "âœ… ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬ í†µê³¼"
    waitFor: ['install-dependencies']

  # =================================
  # Phase 4: ë¦°íŒ…
  # =================================
  - name: 'node:18-slim'
    id: 'lint-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§¹ ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ì‹œì‘..."
        
        # ESLint ì‹¤í–‰
        npm run lint || {
          echo "âŒ ë¦°íŠ¸ ê²€ì‚¬ ì‹¤íŒ¨!"
          echo "ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: npm run lint:fix"
          exit 1
        }
        
        echo "âœ… ë¦°íŠ¸ ê²€ì‚¬ í†µê³¼"
    waitFor: ['security-audit']

  # =================================
  # Phase 5: íƒ€ì… ì²´í¬
  # =================================
  - name: 'node:18-slim'
    id: 'type-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” TypeScript íƒ€ì… ì²´í¬ ì‹œì‘..."
        
        # TypeScript ì»´íŒŒì¼ ì²´í¬
        npm run typecheck || {
          echo "âŒ íƒ€ì… ì²´í¬ ì‹¤íŒ¨!"
          exit 1
        }
        
        echo "âœ… íƒ€ì… ì²´í¬ í†µê³¼"
    waitFor: ['lint-check']

  # =================================
  # Phase 6: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  # =================================
  - name: 'node:18-slim'
    id: 'unit-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        
        # Jest ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        npm run test:unit -- --coverage --coverageReporters=text --coverageReporters=lcov || {
          echo "âŒ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
          exit 1
        }
        
        # ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ í™•ì¸
        coverage_percentage=$(npm run test:unit -- --coverage --coverageReporters=json-summary --silent | jq -r '.total.lines.pct // 0')
        
        if (( $(echo "$coverage_percentage < 70" | bc -l) )); then
          echo "âŒ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¶€ì¡±: ${coverage_percentage}% (ìµœì†Œ 70% í•„ìš”)"
          exit 1
        fi
        
        echo "âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼ (ì»¤ë²„ë¦¬ì§€: ${coverage_percentage}%)"
    env:
      - 'NODE_ENV=test'
    waitFor: ['type-check']

  # =================================
  # Phase 7: í†µí•© í…ŒìŠ¤íŠ¸
  # =================================
  - name: 'node:18-slim'
    id: 'integration-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        
        # Jest í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        npm run test:integration || {
          echo "âŒ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
          exit 1
        }
        
        echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼"
    env:
      - 'NODE_ENV=test'
    waitFor: ['unit-tests']

  # =================================
  # Phase 8: ë¹Œë“œ í…ŒìŠ¤íŠ¸
  # =================================
  - name: 'node:18-slim'
    id: 'build-test'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”¨ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        
        # TypeScript ë¹Œë“œ
        npm run build || {
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          exit 1
        }
        
        # ë¹Œë“œ ì‚°ì¶œë¬¼ í™•ì¸
        if [ ! -d "dist" ] || [ ! -f "dist/index.js" ]; then
          echo "âŒ ë¹Œë“œ ì‚°ì¶œë¬¼ ëˆ„ë½!"
          exit 1
        fi
        
        # ë¹Œë“œ í¬ê¸° í™•ì¸
        build_size=$(du -sh dist | cut -f1)
        echo "ğŸ“¦ ë¹Œë“œ í¬ê¸°: $build_size"
        
        echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼"
    waitFor: ['integration-tests']

  # =================================
  # Phase 9: Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸
  # =================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-build-test'
    args:
      - 'build'
      - '-t'
      - 'writerly-test:$SHORT_SHA'
      - '-f'
      - 'deploy/Dockerfile.prod'
      - '.'
      - '--quiet'
    waitFor: ['build-test']

  # =================================
  # Phase 10: ë³´ì•ˆ ìŠ¤ìº” - Docker ì´ë¯¸ì§€
  # =================================
  - name: 'aquasec/trivy:latest'
    id: 'docker-security-scan'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "ğŸ”’ Docker ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº” ì‹œì‘..."
        
        # Trivyë¡œ ì´ë¯¸ì§€ ìŠ¤ìº” (High/Criticalë§Œ)
        trivy image --exit-code 0 --severity HIGH,CRITICAL --format table writerly-test:$SHORT_SHA || scan_failed=true
        
        # ì·¨ì•½ì  ìš”ì•½ ì¶œë ¥
        echo "ğŸ“Š ì·¨ì•½ì  ìš”ì•½:"
        trivy image --severity HIGH,CRITICAL --format json writerly-test:$SHORT_SHA | \
          jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL") | "\(.Severity): \(.VulnerabilityID) - \(.Title)"' | \
          sort | uniq -c || echo "ì·¨ì•½ì  ì—†ìŒ"
        
        if [[ "$scan_failed" == "true" ]]; then
          echo "âš ï¸ HIGH/CRITICAL ì·¨ì•½ì  ë°œê²¬ë¨ (CIì—ì„œëŠ” ê²½ê³ ë§Œ)"
          echo "í”„ë¡œë•ì…˜ ë°°í¬ ì „ ìˆ˜ì • í•„ìš”"
        else
          echo "âœ… Docker ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº” í†µê³¼"
        fi
    waitFor: ['docker-build-test']

  # =================================
  # Phase 11: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ê°„ë‹¨í•œ ë©”íŠ¸ë¦­)
  # =================================
  - name: 'node:18-slim'
    id: 'performance-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "âš¡ ì„±ëŠ¥ ì²´í¬ ì‹œì‘..."
        
        # ë¹Œë“œ íŒŒì¼ í¬ê¸° ë¶„ì„
        echo "ğŸ“Š íŒŒì¼ í¬ê¸° ë¶„ì„:"
        find dist -name "*.js" -exec ls -lh {} \; | awk '{print $5, $9}' | sort -hr | head -10
        
        # ì˜ì¡´ì„± í¬ê¸° í™•ì¸
        echo "ğŸ“¦ ì˜ì¡´ì„± í¬ê¸°:"
        du -sh node_modules || echo "ì˜ì¡´ì„± ì •ë³´ ì—†ìŒ"
        
        # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì˜ˆì¸¡ (ëŒ€ëµì )
        dependency_count=$(find node_modules -name "package.json" | wc -l)
        echo "ğŸ“ˆ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ìˆ˜: $dependency_count"
        
        if [[ $dependency_count -gt 500 ]]; then
          echo "âš ï¸ ë§ì€ ì˜ì¡´ì„±ìœ¼ë¡œ ì¸í•œ ì ì¬ì  ì„±ëŠ¥ ì´ìŠˆ"
        fi
        
        echo "âœ… ì„±ëŠ¥ ì²´í¬ ì™„ë£Œ"
    waitFor: ['docker-security-scan']

  # =================================
  # Phase 12: CI ê²°ê³¼ ìš”ì•½
  # =================================
  - name: 'node:18-slim'
    id: 'ci-summary'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“‹ CI ê²€ì¦ ê²°ê³¼ ìš”ì•½"
        echo "=================================="
        echo "âœ… ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬ í†µê³¼"
        echo "âœ… ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ í†µê³¼"
        echo "âœ… TypeScript íƒ€ì… ì²´í¬ í†µê³¼"
        echo "âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼"
        echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼"
        echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼"
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ í†µê³¼"
        echo "âœ… ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"
        echo "âœ… ì„±ëŠ¥ ì²´í¬ ì™„ë£Œ"
        echo ""
        echo "ğŸ‰ ëª¨ë“  CI ê²€ì¦ í†µê³¼!"
        echo "ì´ ë¸Œëœì¹˜ëŠ” ë©”ì¸ ë¸Œëœì¹˜ë¡œ ë³‘í•©í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤."
        echo ""
        echo "ğŸ“Š ë¹Œë“œ ì •ë³´:"
        echo "ë¸Œëœì¹˜: $BRANCH_NAME"
        echo "ì»¤ë°‹: $SHORT_SHA"
        echo "ë¹Œë“œ ID: $BUILD_ID"
        echo "ë¹Œë“œ ì‹œê°„: $(date)"
    waitFor: ['performance-check']

# =================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# =================================
substitutions:
  _BRANCH_NAME: '$BRANCH_NAME'

# =================================
# ë¹Œë“œ ì˜µì…˜
# =================================
options:
  logging: CLOUD_LOGGING_ONLY
  dynamicSubstitutions: true
  substitutionOption: ALLOW_LOOSE
  machineType: 'N1_HIGHCPU_8'  # CIìš© ê³ ì„±ëŠ¥ ë¨¸ì‹ 

# =================================
# íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ë¶„)
# =================================
timeout: '600s'

# =================================
# ë¡œê·¸ ì„¤ì •
# =================================
logsBucket: 'gs://$PROJECT_ID-ci-logs'