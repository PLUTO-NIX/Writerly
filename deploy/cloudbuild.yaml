# DevSecOps í†µí•© ë°°í¬ íŒŒì´í”„ë¼ì¸
# ADR-009: Fire-and-Forget ë°°í¬ íŒ¨í„´ ì ìš©
# ë³´ì•ˆ ìŠ¤ìº” í†µí•©ìœ¼ë¡œ ì·¨ì•½ì  ìë™ ì°¨ë‹¨

steps:
  # =================================
  # Phase 1: í™˜ê²½ ì„¤ì • ë° ì˜ì¡´ì„± ì„¤ì¹˜
  # =================================
  - name: 'node:18-slim'
    id: 'install-dependencies'
    entrypoint: 'npm'
    args: ['ci', '--only=production']
    env:
      - 'NODE_ENV=production'

  - name: 'node:18-slim'
    id: 'install-dev-dependencies'
    entrypoint: 'npm'
    args: ['ci']
    env:
      - 'NODE_ENV=development'

  # =================================
  # Phase 2: ë³´ì•ˆ ìŠ¤ìº” 1 - ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
  # =================================
  - name: 'node:18-slim'
    id: 'security-scan-dependencies'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”’ ì˜ì¡´ì„± ë³´ì•ˆ ìŠ¤ìº” ì‹œì‘..."
        
        # npm auditë¡œ ì·¨ì•½ì  ìŠ¤ìº”
        npm audit --audit-level=moderate || exit_code=$?
        
        if [ $${exit_code:-0} -ne 0 ]; then
          echo "âŒ ì¤‘ê°„ê¸‰ ì´ìƒ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬!"
          echo "ì·¨ì•½ì ì´ ìˆëŠ” ì˜ì¡´ì„±ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
          npm audit
          exit 1
        fi
        
        echo "âœ… ì˜ì¡´ì„± ë³´ì•ˆ ìŠ¤ìº” í†µê³¼"
    waitFor: ['install-dev-dependencies']

  # =================================
  # Phase 3: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  # =================================
  - name: 'node:18-slim'
    id: 'run-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘..."
        
        # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        npm run test:unit || {
          echo "âŒ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
          exit 1
        }
        
        # í†µí•© í…ŒìŠ¤íŠ¸
        npm run test:integration || {
          echo "âŒ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
          exit 1
        }
        
        echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
    env:
      - 'NODE_ENV=test'
    waitFor: ['security-scan-dependencies']

  # =================================
  # Phase 4: ë¹Œë“œ ë° íƒ€ì… ì²´í¬
  # =================================
  - name: 'node:18-slim'
    id: 'build-application'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì‹œì‘..."
        
        # TypeScript ì»´íŒŒì¼
        npm run build || {
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          exit 1
        }
        
        # íƒ€ì… ì²´í¬
        npm run typecheck || {
          echo "âŒ íƒ€ì… ì²´í¬ ì‹¤íŒ¨!"
          exit 1
        }
        
        # ë¦°íŠ¸ ì²´í¬
        npm run lint || {
          echo "âŒ ë¦°íŠ¸ ì²´í¬ ì‹¤íŒ¨!"
          exit 1
        }
        
        echo "âœ… ë¹Œë“œ ë° ì •ì  ë¶„ì„ ì™„ë£Œ"
    waitFor: ['run-tests']

  # =================================
  # Phase 5: Docker ì´ë¯¸ì§€ ë¹Œë“œ
  # =================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - '$_IMAGE_URL'
      - '-f'
      - 'deploy/Dockerfile.prod'
      - '.'
    waitFor: ['build-application']

  # =================================
  # Phase 6: ë³´ì•ˆ ìŠ¤ìº” 2 - ì»¨í…Œì´ë„ˆ ì·¨ì•½ì  ìŠ¤ìº”
  # =================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    id: 'security-scan-container'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”’ ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ìŠ¤ìº” ì‹œì‘..."
        
        # Artifact Registryì— ì„ì‹œ í‘¸ì‹œ (ìŠ¤ìº”ìš©)
        docker push $_IMAGE_URL
        
        # ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì·¨ì•½ì  ìŠ¤ìº”
        gcloud artifacts docker images scan $_IMAGE_URL \
          --format="value(response.scan.analysisStatus)" > scan_status.txt
        
        scan_status=$(cat scan_status.txt)
        
        if [[ "$scan_status" == "SCAN_STATUS_SUCCESS" ]]; then
          # ì·¨ì•½ì  ê²°ê³¼ í™•ì¸
          gcloud artifacts docker images list-tags \
            $(echo $_IMAGE_URL | cut -d':' -f1) \
            --format="value(digest)" \
            --filter="tags:$(echo $_IMAGE_URL | cut -d':' -f2)" > digest.txt
          
          digest=$(cat digest.txt)
          
          # ê³ ìœ„í—˜ ì·¨ì•½ì  í™•ì¸
          critical_count=$(gcloud artifacts docker images describe \
            $(echo $_IMAGE_URL | cut -d':' -f1)@$digest \
            --format="value(image_basis.vulnerability_assessment.summary.critical)" || echo "0")
          
          high_count=$(gcloud artifacts docker images describe \
            $(echo $_IMAGE_URL | cut -d':' -f1)@$digest \
            --format="value(image_basis.vulnerability_assessment.summary.high)" || echo "0")
          
          echo "Critical ì·¨ì•½ì : $critical_countê°œ"
          echo "High ì·¨ì•½ì : $high_countê°œ"
          
          # ì„ê³„ê°’ í™•ì¸ (Critical: 0, High: 5 ì´í•˜)
          if [[ ${critical_count:-0} -gt 0 ]] || [[ ${high_count:-0} -gt 5 ]]; then
            echo "âŒ í—ˆìš© ìˆ˜ì¤€ì„ ì´ˆê³¼í•˜ëŠ” ì·¨ì•½ì  ë°œê²¬!"
            echo "Critical: ${critical_count:-0}/0, High: ${high_count:-0}/5"
            echo "ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ìŠ¤ìº” í†µê³¼"
        else
          echo "âŒ ì»¨í…Œì´ë„ˆ ìŠ¤ìº” ì‹¤íŒ¨: $scan_status"
          exit 1
        fi
    waitFor: ['build-image']

  # =================================
  # Phase 7: ë³´ì•ˆ ìŠ¤ìº” 3 - Trivy ì •ì  ë¶„ì„
  # =================================
  - name: 'aquasec/trivy:latest'
    id: 'security-scan-trivy'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "ğŸ”’ Trivy ì •ì  ë¶„ì„ ì‹œì‘..."
        
        # Trivyë¡œ ì´ë¯¸ì§€ ìŠ¤ìº”
        trivy image --exit-code 1 --severity HIGH,CRITICAL --no-progress $_IMAGE_URL || {
          echo "âŒ Trivyì—ì„œ HIGH/CRITICAL ì·¨ì•½ì  ë°œê²¬!"
          echo "ìƒì„¸ ì •ë³´:"
          trivy image --severity HIGH,CRITICAL --no-progress $_IMAGE_URL
          exit 1
        }
        
        echo "âœ… Trivy ì •ì  ë¶„ì„ í†µê³¼"
    waitFor: ['security-scan-container']

  # =================================
  # Phase 8: ìµœì¢… ì´ë¯¸ì§€ í‘¸ì‹œ (ë³´ì•ˆ ìŠ¤ìº” í†µê³¼ ì‹œì—ë§Œ)
  # =================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args: ['push', '$_IMAGE_URL']
    waitFor: ['security-scan-trivy']

  # =================================
  # Phase 9: Cloud Run ë°°í¬ (ì¦‰ì‹œ ë°°í¬ - ADR-009)
  # =================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    id: 'deploy-to-cloudrun'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Cloud Run ë°°í¬ ì‹œì‘..."
        
        gcloud run deploy $_SERVICE_NAME \
          --image $_IMAGE_URL \
          --region $_REGION \
          --platform managed \
          --allow-unauthenticated \
          --memory 512Mi \
          --cpu 1 \
          --concurrency 100 \
          --max-instances 10 \
          --min-instances 0 \
          --timeout 60s \
          --set-env-vars "NODE_ENV=production" \
          --set-env-vars "VERTEX_AI_PROJECT_ID=$PROJECT_ID" \
          --set-env-vars "VERTEX_AI_LOCATION=$_REGION" \
          --set-env-vars "CLOUD_TASKS_PROJECT_ID=$PROJECT_ID" \
          --set-env-vars "CLOUD_TASKS_LOCATION=$_REGION" \
          --set-env-vars "CLOUD_TASKS_QUEUE=$_QUEUE_NAME" \
          --port 8080 \
          --traffic 100 \
          --quiet
        
        echo "âœ… Cloud Run ë°°í¬ ì™„ë£Œ"
    waitFor: ['push-image']

  # =================================
  # Phase 10: ë°°í¬ ìƒíƒœ ê²€ì¦
  # =================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    id: 'verify-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” ë°°í¬ ìƒíƒœ ê²€ì¦ ì‹œì‘..."
        
        # ì„œë¹„ìŠ¤ URL íšë“
        SERVICE_URL=$(gcloud run services describe $_SERVICE_NAME \
          --region $_REGION \
          --format="value(status.url)")
        
        echo "ì„œë¹„ìŠ¤ URL: $SERVICE_URL"
        
        # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ (ìµœëŒ€ 5ë¶„ ëŒ€ê¸°)
        for i in {1..30}; do
          if gcloud run services describe $_SERVICE_NAME --region $_REGION \
            --format="value(status.conditions[0].status)" | grep -q "True"; then
            echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ìƒíƒœ í™•ì¸"
            break
          fi
          
          if [[ $i -eq 30 ]]; then
            echo "âŒ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ íƒ€ì„ì•„ì›ƒ"
            exit 1
          fi
          
          echo "ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 10
        done
        
        # í™˜ê²½ ë³€ìˆ˜ì— SERVICE_URL ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©)
        echo "SERVICE_URL=$SERVICE_URL" >> /workspace/deployment.env
    waitFor: ['deploy-to-cloudrun']

  # =================================
  # Phase 11: Smoke Test ìë™ ì‹¤í–‰
  # =================================
  - name: 'curlimages/curl:latest'
    id: 'smoke-test'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "ğŸ§ª Smoke Test ì‹œì‘..."
        
        # ë°°í¬ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
        source /workspace/deployment.env
        
        # Health Check
        echo "1ï¸âƒ£ Health Check í…ŒìŠ¤íŠ¸..."
        if ! curl -f -s -m 30 "$SERVICE_URL/health" > /dev/null; then
          echo "âŒ Health Check ì‹¤íŒ¨"
          exit 1
        fi
        echo "âœ… Health Check í†µê³¼"
        
        # API ì‘ë‹µ í…ŒìŠ¤íŠ¸
        echo "2ï¸âƒ£ API ì‘ë‹µ í…ŒìŠ¤íŠ¸..."
        health_response=$(curl -s -m 30 "$SERVICE_URL/health")
        if ! echo "$health_response" | grep -q "healthy"; then
          echo "âŒ Health API ì‘ë‹µ ì´ìƒ: $health_response"
          exit 1
        fi
        echo "âœ… API ì‘ë‹µ ì •ìƒ"
        
        # ì‘ë‹µ ì‹œê°„ í…ŒìŠ¤íŠ¸ (5ì´ˆ ì´ë‚´)
        echo "3ï¸âƒ£ ì‘ë‹µ ì‹œê°„ í…ŒìŠ¤íŠ¸..."
        response_time=$(curl -o /dev/null -s -w '%{time_total}' -m 10 "$SERVICE_URL/health")
        response_time_ms=$(echo "$response_time * 1000" | bc -l)
        
        if (( $(echo "$response_time > 5.0" | bc -l) )); then
          echo "âŒ ì‘ë‹µ ì‹œê°„ ì´ˆê³¼: ${response_time}ì´ˆ"
          exit 1
        fi
        echo "âœ… ì‘ë‹µ ì‹œê°„ ì •ìƒ: ${response_time}ì´ˆ"
        
        echo "ğŸ‰ ëª¨ë“  Smoke Test í†µê³¼!"
    waitFor: ['verify-deployment']

  # =================================
  # Phase 12: ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ë° ë¡¤ë°± ì •ë³´ ì œê³µ
  # =================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    id: 'deployment-summary'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“‹ ë°°í¬ ì™„ë£Œ ìš”ì•½"
        echo "=================================="
        
        # ë°°í¬ ì •ë³´ ìˆ˜ì§‘
        source /workspace/deployment.env
        REVISION=$(gcloud run services describe $_SERVICE_NAME \
          --region $_REGION \
          --format="value(status.latestRevision)")
        
        echo "âœ… ë°°í¬ ì„±ê³µ!"
        echo "ì„œë¹„ìŠ¤: $_SERVICE_NAME"
        echo "ë¦¬ì „: $_REGION"
        echo "ì´ë¯¸ì§€: $_IMAGE_URL"
        echo "ë¦¬ë¹„ì „: $REVISION"
        echo "URL: $SERVICE_URL"
        echo ""
        echo "ğŸ”„ ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš°:"
        echo "gcloud run services update-traffic $_SERVICE_NAME \\"
        echo "  --region $_REGION \\"
        echo "  --to-revisions PREVIOUS_REVISION=100"
        echo ""
        echo "ğŸ“Š í˜„ì¬ íŠ¸ë˜í”½ ë¶„ë°°:"
        gcloud run services describe $_SERVICE_NAME \
          --region $_REGION \
          --format="table(status.traffic[].revisionName,status.traffic[].percent)"
        echo ""
        echo "ğŸŠ ë°°í¬ ì™„ë£Œ! íŒ€ì›ë“¤ì´ ì´ì œ Slackì—ì„œ '/ai' ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    waitFor: ['smoke-test']

# =================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# =================================
substitutions:
  _IMAGE_URL: 'gcr.io/$PROJECT_ID/writerly-slack-ai:$BUILD_ID'
  _SERVICE_NAME: 'writerly-slack-ai'
  _REGION: 'us-central1'
  _QUEUE_NAME: 'ai-processing-queue'

# =================================
# ë¹Œë“œ ì˜µì…˜
# =================================
options:
  logging: CLOUD_LOGGING_ONLY
  dynamicSubstitutions: true
  substitutionOption: ALLOW_LOOSE

# =================================
# íƒ€ì„ì•„ì›ƒ ì„¤ì • (20ë¶„)
# =================================
timeout: '1200s'

# =================================
# ë¡œê·¸ ì„¤ì •
# =================================
logsBucket: 'gs://$PROJECT_ID-build-logs'

# =================================
# ë¹Œë“œ ì™„ë£Œ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
# =================================
# images: ['$_IMAGE_URL']